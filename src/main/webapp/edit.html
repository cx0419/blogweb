<html lang="zh-cn">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0;"/>
    <title>editor.md 编辑器</title>
<!--    编辑器配置-->
    <script src="js/jquery-3.3.1.min.js"></script>
    <link rel="stylesheet" href="editor.md/examples/css/style.css">
    <link rel="stylesheet" href="editor.md/css/editormd.css">
    <link rel="stylesheet" href="iconfont/iconfont.css">
    <link rel="stylesheet" href="css/Bootstrap.css">
    <script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="js/ajaxfileupload.js"></script>
    <script type="text/javascript" src="editor.md/editormd.js"></script>
    <script src="editor.md/lib/marked.min.js"></script>
    <script src="editor.md/lib/prettify.min.js"></script>
    <script src="editor.md/lib/raphael.min.js"></script>
    <script src="editor.md/lib/underscore.min.js"></script>
    <script src="editor.md/lib/sequence-diagram.min.js"></script>
    <script src="editor.md/lib/flowchart.min.js"></script>
    <script src="editor.md/lib/jquery.flowchart.min.js"></script>
    <script src="js/uploadImg.js" type="text/javascript"></script>
    <script src="js/axios-0.18.0.min.js"></script>
    <script src="js/axiosUtil.js" type="text/javascript"></script>
    <script src="js/loadnav.js"></script>
    <link rel="stylesheet" href="css/headnav.css">
    <link rel="stylesheet" href="css/edit.css">

</head>
<body>
<div class="editormd">
    <div class="editormd-top">
        <div class="iconfont savebtn articlebtn" onclick="uploadblog();">&#xf00f5;上传博客</div>
        <input id="title" class="title" type="text" placeholder="在此输入标题...." value="[无标题]">
        <div id="savedraftbtn" class="iconfont draftbtn articlebtn" onclick="savedraft();">&#xe67d;保存草稿</div>
    </div>
    <div id="submitdiv" class="editormd-mid">
        <div class="content-description">
            <div class="leftintro">封面&摘要</div>
            <img id="coverimg" onclick="popWindow()" class="content-description-img" src="https://tse3-mm.cn.bing.net/th/id/OIP-C.EAFZlKJGvDqY8_T-Q1oZBwHaHa?w=196&h=196&c=7&r=0&o=5&dpr=1.5&pid=1.7" alt="">
            <textarea id="description" class="content-description-text" placeholder="输入对文章的描述,清晰的描述有助于您文章被更多的人看到"></textarea>
        </div>
        <div class="content-tag">
            <div class="leftintro">文章标签</div>
                <div id="selecttag">
                    <div class="tags">
<!--                        <div class="tag_item">-->
<!--                            <p>23333</p>-->
<!--                            <span class="btn_x tagspan">X</span>-->
<!--                        </div>-->
                    </div>
                    <div class="box"><input id="tag_input" type="text" placeholder="按回车添加标签"></div>
                    <div id="tagtips" class="tagtips">
                        还可以添加十个标签
                    </div>
                </div>
            <div class="singleselect-tag">
                <div style="border-radius: 3px;border:2px solid #d2d2d2;" class="dropdown">
                    <button type="button" class="btn dropdown-toggle" id="dropdownMenu1" data-toggle="dropdown">标签
                        <span class="caret"></span>
                    </button>
                    <!--待选标签-->
                    <ul  id="singleselect-tag-list" style="overflow-y: auto;height: 200px;" class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">java</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">eclipse</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">tomcat</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">hibernate</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">spring</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">maven</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">struts</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">kafka</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">intellij-idea</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">java-ee</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">spring boot</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">spring cloud</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">jvm</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">jetty</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">junit</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">log4j</a>
                        </li>
                        <li role="presentation">
                            <a class="tag-menuitem" role="menuitem" tabindex="-1" href="javascript:void(0);">servlet</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="content-sclumn">
            <div class="leftintro">分类专栏</div>
            <div id="selectsclumn">
                <div class="sclumns">
<!--                    <div class="tag_item">-->
<!--                        <p>23333</p>-->
<!--                        <span class="btn_x tagspan">X</span>-->
<!--                    </div>-->
                </div>
                <div class="box"><input id="sclumn_input" type="text" placeholder="按回车添加标签"></div>
                <div id="columntips" class="columntips">
                    还可以添加十个专栏
                </div>
            </div>
            <div class="singleselect-column">
                <div style="border-radius: 3px;border:2px solid #d2d2d2;" class="dropdown">
                    <button type="button" class="btn dropdown-toggle" id="dropdownMenu2" data-toggle="dropdown">专栏
                        <span class="caret"></span>
                    </button>
                    <ul  id="singleselect-column-list" style="overflow-y: auto;height: 200px;" class="dropdown-menu" role="menu" aria-labelledby="dropdownMenu1">
                        <li role="presentation">
                            <a class="column-menuitem" role="menuitem" tabindex="-1" href="#">Java</a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
        <div class="content-type">
            <div class="leftintro">文章类型</div>
            <div class="content-shtype-right">
                <input class="articletypeselect" type="radio" name="articletype" checked value="原创">原创
                <input class="articletypeselect" type="radio" name="articletype" checked value=“转载”>转载
            </div>
        </div>
        <div class="content-bnt">
            <div id="okTouploadOrAlter" class="iconfont savebtn articlebtn uploadok" onclick="uploadok();">&#xf00f5;确认上传</div>
        </div>
    </div>
    <div id="editormd" class="editormdinner">
            <textarea className="editormd-html-textarea" name="content">

            </textarea>
    </div>

</div>

<script type="text/javascript">
    /* 编辑器 */
    let testEditor;
    $(function () {
        testEditor = editormd("editormd", {
            width: 1400,
            height: 900,
            syncScrolling: "single",
            path: "editor.md/lib/",
            // theme: "dark",//工具栏主题
            previewTheme: "dark",//预览主题
            editorTheme: "pastel-on-dark",//编辑主题
            saveHTMLToTextarea: true,  // 开启获取 html 源码
            flowChart: true,//控制流程图编辑
            sequenceDiagram: true,//控制时序图编辑
            taskList: true,//任务列表
            tex: true,//科学公式
            emoji: true,//moji表情
            //htmlDecode : true,
            htmlDecode: "style,script,iframe|on*", // 开启 HTML 标签解析，为了安全性，默认不开启
            codeFold: true,    //ctrl+q代码折叠
            imageUpload: true,//开启本地图片上传
            imageFormats: ["jpg", "jpeg", "gif", "png", "bmp", "webp"],
            imageUploadURL: "/BlogWeb/FileServlet?method=BlogImg",//图片上传接口
            onload : function() {
                // initPasteDragImg(this);
                //如果是编辑则会进行一次数据拉取
                alterblogevent();
            },
            dialogLockScreen: false,   // 设置弹出层对话框不锁屏，全局通用，默认为true
            dialogShowMask: false,     // 设置弹出层对话框显示透明遮罩层，全局通用，默认为true
            dialogDraggable: false,    // 设置弹出层对话框不可拖动，全局通用，默认为true
            dialogMaskOpacity: 0.4,    // 设置透明遮罩层的透明度，全局通用，默认值为0.1
            dialogMaskBgColor: "#000", // 设置透明遮罩层的背景颜色，全局通用，默认为#fff
            //自定义工具栏
            toolbarIcons: function () {
                return [
                    "undo", "redo", "|",
                    "bold", "del", "italic", "quote", "ucwords", "uppercase", "lowercase", "|",
                    "h1", "h2", "h3", "h4", "h5", "h6", "|",
                    "list-ul", "list-ol", "hr", "|",
                    "link", "reference-link", "image", "code", "preformatted-text", "code-block", "table", "datetime", "emoji", "html-entities", "pagebreak", "|",
                    "goto-line", "watch", "preview", "fullscreen", "clear", "search", "|",
                    "help", "info", "leftIcon", "centerIcon", "rightIcon"]
            },
            /*自定义功能按钮，下面我自定义了2个，一个是发布，一个是返回首页*/
            // toolbarIconTexts : {
            //     releaseIcon : "<span bgcolor=\"gray\">发布</span>",
            //     index : "<span bgcolor=\"red\">返回首页</span>",
            // },

            //如果没有图标，可以文字表述toolbarIconTexts:{ leftIcon:"left",},
            toolbarIconsClass: {
                leftIcon: "fa-align-left",
                centerIcon: "fa-align-center",
                rightIcon: "fa-align-right"
            },
            // 自定义工具栏按钮的事件处理
            toolbarHandlers: {
                leftIcon: function (cm, icon, cursor, selection) {
                    cm.replaceSelection("<p align='left'>" + selection + "</p>");
                    if (selection === "") {
                        cm.setCursor(cursor.line, cursor.ch + 16);
                    }
                },
                centerIcon: function (cm, icon, cursor, selection) {
                    cm.replaceSelection("<p align='center'>" + selection + "</p>");
                    if (selection === "") {
                        cm.setCursor(cursor.line, cursor.ch + 18);
                    }
                },
                rightIcon: function (cm, icon, cursor, selection) {
                    cm.replaceSelection("<p align='right'>" + selection + "</p>");
                    if (selection === "") {
                        cm.setCursor(cursor.line, cursor.ch + 17);
                    }
                }
            },
            lang: {
                toolbar: {
                    leftIcon: "居左",
                    centerIcon: "居中",
                    rightIcon: "居右"
                }
            },
        });

    });
    // testEditor.setMarkdown('');//清空编辑框的内容
    editormd.markdownToHTML('md_html',{
        htmlDecode: "style,script,iframe", //可以过滤标签解码
        emoji: true,
        taskList: true,
        tex: true,
        flowChart: true,
        sequenceDiagram: true,
    });

</script>
<script type="text/javascript">

    // 获取指定名称的cookie
    function getCookie(name){
        var strcookie = document.cookie;//获取cookie字符串
        var arrcookie = strcookie.split("; ");//分割
        //遍历匹配
        for ( var i = 0; i < arrcookie.length; i++) {
            var arr = arrcookie[i].split("=");
            if (arr[0] === name){
                return arr[1];
            }
        }
        return "";
    }
    var title = document.getElementById("title");
    // alert("title:"+title);
    var content = $("content");


    function uploadblog(){
        let showValue =window.getComputedStyle(document.getElementById("submitdiv")).display //返回到id = show的div的display的值
        if(showValue === "" || showValue === "none"){
            $('#submitdiv').css("display","flex");
        }else if(showValue === "flex"){
            $('#submitdiv').css("display","none");
        }
    }


    function gotohelp(){
        window.location.href="http://editor.md.ipandao.com/examples/full.html";
    }
    function a(){
       console.log(testEditor.getHTML());
    }
</script>
<script>
    let input = document.createElement('input');
    input.type = 'file';
    input.id="files";
    input.name = 'file';
    let body = document.getElementsByTagName('body')[0];
    body.appendChild(input)
    //上传封面
    $('input:file').change(function () {
        // 上传文件
        $.ajaxFileUpload({
            url: "http://localhost:8080/BlogWeb/FileServlet?method=uploadCover",
            type: "POST",
            //文件选择框的id属性
            fileElementId: 'files',
            data:{
                id:getCookie("id")
            },
            //服务器返回的格式
            dataType: 'json',
            success: function (data) {
                console.log(data);
                document.getElementById("coverimg").setAttribute("src",data.url);
            },
            error: function (data, status, e) {
                console.log(e);
            }
        });
    });
    function popWindow() {
        // input.setAttribute("display","none");
        input.click();
    }
    //判重
    function checkRepeat(element,value){
        var set= [];
        let n = element.getElementsByTagName("div").length;
        for(let i = 0 ; i < n ; i++){
            set.push(element.getElementsByTagName("div")[i].getElementsByTagName("p")[0].innerHTML);
        }
        for(let i=0 ; i<n ; i++){
            if(value===set[i]){
                return false;
            }
        }
        return true;
    }
    //获取所有值
    function getValue(element){
        var set= [];
        let n = element.getElementsByTagName("div").length;
        for(let i = 0 ; i < n ; i++){
            set.push(element.getElementsByTagName("div")[i].getElementsByTagName("p")[0].innerHTML);
        }
        return set;
    }

    //添加标签input
    let tags = document.getElementsByClassName("tags")[0];
    let num2 = tags.getElementsByTagName("div").length;
    document.getElementById("tagtips").innerHTML = "还可以添加" + (5-num2) + "个标签";
    document.getElementById("tag_input").addEventListener("keydown",function (e){
        if(e.keyCode=== 13){
            add_tag(this.value);
            this.value = '';
        }
    })
    document.getElementById("selecttag").addEventListener("click",function (e){
        var event = e|| window.event;
        var target = event.target || event.srcElement;

        if(e.target.nodeName === "p"){
            console.log(2333);
        }
        if(e.target.className === "btn_x"){
            let num = tags.getElementsByTagName("div").length;
            if(num<=0){
                return;
            }
            console.log(e.target.parentNode.parentNode.removeChild(e.target.parentNode));
            document.getElementById("tagtips").innerHTML = "还可以添加" + (5-(num-1)) + "个标签";
        }
    })

    function add_tag(tag_name){
        let num = tags.getElementsByTagName("div").length;
        if(tag_name==null || tag_name===""){
            popErrorWindows("标签名不能为空！");
            return;
        }
        if(!checkRepeat(tags,tag_name)){
            popErrorWindows("您重复添加了标签！");
            return;
        }
        if(num>=5){
            popErrorWindows("专栏数量已经到达上限！");
            return;
        }
        var child = document.createElement('div');
        child.className = 'tag_item';
        child.innerHTML = "<p>"+tag_name+"</p><span class=\"btn_x\">X</span>"
        tags.appendChild(child);
        document.getElementById("tagtips").innerHTML = "还可以添加" + (5-(num+1)) + "个标签";
    }
</script>

<!--//添加专栏input-->
<script>
    let columns = document.getElementsByClassName("sclumns")[0];
    let num1 = columns.getElementsByTagName("div").length;
    document.getElementById("columntips").innerHTML = "还可以添加" + (5-num1) + "个专栏";
    document.getElementById("sclumn_input").addEventListener("keydown",function (e){
        if(e.keyCode=== 13){
            add_clumn(this.value);
            this.value = '';
        }
    })
    document.getElementById("selectsclumn").addEventListener("click",function (e){
        var event = e|| window.event;

        var target = event.target || event.srcElement;

        if(e.target.nodeName === "p"){
            console.log(2333);
        }
        if(e.target.className === "btn_x"){
            let num = columns.getElementsByTagName("div").length;
            if(num<=0){
                return;
            }
            console.log(e.target.parentNode.parentNode.removeChild(e.target.parentNode));
            document.getElementById("columntips").innerHTML = "还可以添加" + (5-(num-1)) + "个专栏";
        }
    })
    function add_clumn(tag_name){
        let num = columns.getElementsByTagName("div").length;
        if(tag_name==null || tag_name===""){
            popErrorWindows("专栏名不能为空！");
            return;
        }
        if(!checkRepeat(columns,tag_name)){
            popErrorWindows("您重复添加了专栏！");
            return;
        }

        if(num>=5){
            popErrorWindows("专栏数量已经到达上限！");
            return;
        }
        var child = document.createElement('div');
        child.className = 'tag_item';
        child.innerHTML = "<p>"+tag_name+"</p><span class=\"btn_x\">X</span>"
        columns.appendChild(child);
        document.getElementById("columntips").innerHTML = "还可以添加" + (5-(num+1)) + "个专栏";
    }
</script>

<script>

    function alterblogevent(){
        if(GetUrlParam("articleid")!==null&&checknum(GetUrlParam('articleid'))){
            alert("编辑文章");
            //说明是修改文章 , 那就先把文章内容获取到
            AxiosPostRequst("http://localhost:8080/BlogWeb/BlogServlet?method=selectBlog",{
                "id":GetUrlParam("articleid")
            }).then(res => {
                let blog = res.blog;
                let userExtend = res.userExtend;
                let user = res.user;
                Myuser = user;
                let columnAndNums = res.columnAndNums;
                let tags =res.tags;
                let msg = res.msg;
                //非草稿状态下的修改文章不能被保存草稿
                document.getElementById('okTouploadOrAlter').innerHTML = "确认修改";
                $('#savedraftbtn').css('display','none');
                //文章内容
                document.getElementById("title").value = blog.title;
                document.getElementById('coverimg').setAttribute('src',blog.firstPicture);
                alert("博客内容"+blog.content);
                testEditor.setMarkdown(blog.content);
                document.getElementById("description").value = blog.description;
                //标签
                for(let i = 0 ; i < tags.length ; i++){
                    let str = tags[i].name;
                    add_tag(str);
                }
                //专栏
                for(let i = 0 ; i < columnAndNums.length ; i++){
                    let column = columnAndNums[i].column;
                    let num = columnAndNums[i].num;
                    add_clumn(column.name);
                }
            });
        }
    }
    //博客上传事件 一种我直接一篇新的博客 还有一种是草稿 这个接口如果传过去articleid,那么将会是修改
    function blogevent(isdraft){
        let num = tags.getElementsByTagName("div").length;
        if(testEditor.getHTML()==="" || title===""){
            popErrorWindows("请将博客需要的内容输入完整");
            return;
        }
        if(num < 2){
            popErrorWindows("请为您的博客添加标签");
            return;
        }
        let original = document.getElementsByName("articletype");
        let pr;
        let examinetemp =  isdraft?"草稿":"审核中";
        for (let i = 0; i <original.length ; i++) {
            if(original[i].checked)
                pr = original[i].value;
        }
        pr = pr === "原创";
        let blog;
        // alert(testEditor.getHTML());
        // alert("判断结果:"+GetUrlParam("articleid")+" 为:"+checknum(GetUrlParam("articleid")))
        if(checknum(GetUrlParam("articleid"))){
            // alert("编辑");
            blog={
                //将文章id传过去
                id:GetUrlParam("articleid"),
                title:title.value,
                content:testEditor.getMarkdown(),
                description:description.value,
                fistPicture:document.getElementById("coverimg").getAttribute("src"),
                createTime:new Date().Format("yyyy-MM-dd hh:mm:ss"),
                updateTime:new Date().Format("yyyy-MM-dd hh:mm:ss"),
                appreciation:0,
                views:0,
                collection:0,
                commentable:true,
                original:pr,
                specialColumnId:null,
                userId:getCookie("id"),
                examine:examinetemp,
            }
        }else{
            // alert(GetUrlParam("articleid")+"添加");
            blog={
                title:title.value,
                content:testEditor.getMarkdown(),
                description:description.value,
                fistPicture:document.getElementById("coverimg").getAttribute("src"),
                createTime:new Date().Format("yyyy-MM-dd hh:mm:ss"),
                updateTime:new Date().Format("yyyy-MM-dd hh:mm:ss"),
                appreciation:0,
                views:0,
                collection:0,
                commentable:true,
                original:pr,
                specialColumnId:null,
                userId:getCookie("id"),
                examine:examinetemp,
            }
        }
        AxiosPostRequst("http://localhost:8080/BlogWeb/BlogServlet?method=saveBlog",{
            "blog":JSON.stringify(blog),
            "columns":JSON.stringify(getValue(columns)),
            "tags":JSON.stringify(getValue(tags))
        }).then(res => {
            alert(res.msg);
            if(!isdraft){
                popSucceedWindows("上传成功！,请等待审核通过");
                location.href="http://localhost:8080/BlogWeb/blogPage.html?articleid="+res.blogid;
            }else{
                popSucceedWindows("草稿保存成功,您现在可以对其进行修改");
                location.href="http://localhost:8080/BlogWeb/edit.html?articleid="+res.blogid;
            }
        });
    }
    <!--上传博客-->
    function uploadok(){
        blogevent(false);
    }
    <!--上传草稿-->
    function savedraft(){
        blogevent(true);
    }

</script>

<!--拉取标签,专栏下拉框内容-->
<script>
    $("body").on('click','.tag-menuitem',e=> {
        let tagname = e.target.innerHTML;
        add_tag(tagname);
    });
    $("body").on('click','.column-menuitem',e=> {
        let columnname = e.target.innerHTML;
        add_clumn(columnname);
    });
    //去服务器拉取这个人的所有专栏加载进来
    AxiosPostRequst("http://localhost:8080/BlogWeb/ColumnServlet?method=getDropdownColumn",{
        'w':1
    }).then(res=>{
        let columns = res.columns;
        let ans = "";
        let str1 = "                        <li role=\"presentation\">\n" +
            "                            <a class='column-menuitem' role=\"menuitem\" tabindex=\"-1\" href=\"#\">"
        let str2 ="</a>\n" +
            "                        </li>";
        for(let i = 0 ; i < columns.length ; i++){
            let column = columns[i];
            ans += str1 + column.name +str2;
        }
        document.getElementById("singleselect-column-list").innerHTML = ans;
        console.log(ans);
    });

</script>
</body>
</html>